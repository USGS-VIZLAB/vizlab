<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Laura DeCicco" />

<meta name="date" content="2017-02-28" />

<title>Collaboration Example</title>






<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Collaboration Example</h1>
<h4 class="author"><em>Laura DeCicco</em></h4>
<h4 class="date"><em>2017-02-28</em></h4>



<div id="jumping-in" class="section level1">
<h1>Jumping in!</h1>
<p>The vignette “Vizlab Example” gives a good overview on the complete process for initializing and creating a visualization product from <code>vizlab</code>. However, much of the infrastructure set up in this package is to improve the way we can collaborate during the visualization creation.</p>
<div id="github" class="section level2">
<h2>Github</h2>
<p>During our collaboration “sprints”, we first assume all contributors are not only comfortable with git, but also the specific git-workflow that our team uses. The scope of this vignette is not to give a complete picture of this git workflow. To briefly summarize however, we have a canonical “upstream” repository that each member forks off. Team members are encouraged to create a branch off their fork for each distinct task. When a task is complete, they submit a pull request to the canonical repository. A different team member should review the pull request before merging onto the master branch. We tend to heavily take advantage of Github’s Issues and project task management. Ideally, one pull request should correspond to one Issue, and that Issue can be closed with the merged pull request.</p>
</div>
<div id="assign-a-task" class="section level2">
<h2>Assign a Task</h2>
<p>Early on in the <code>vizlab</code> development, we made a data visualization of water use in the United States. The final product can be seen here:</p>
<p><a href="https://owi.usgs.gov/vizlab/water-use/" class="uri">https://owi.usgs.gov/vizlab/water-use/</a></p>
<p>The canonical GitHub repository for that work is here:</p>
<p><a href="https://github.com/USGS-VIZLAB/water-use" class="uri">https://github.com/USGS-VIZLAB/water-use</a></p>
<p>Let’s use this project to create a fictional task, and walk through the process of contributing to the project. Our fictional task is to change the way we “clean”&quot; the national water use data. When we were first were given the data, we had no consistent Industrial or Thermoelectric values of water use data before 1960. However, in our fictional example, let’s say we were provided with a csv file with 1955 Thermoelectric water use data by state. So now our fictional project lead has created two tasks, and assigned these tasks to us:</p>
<p>Task #1. Pull in the data file thermoelectric_1955.csv</p>
<p>Task #2. Merge that data into the existing cleaned national state data.</p>
<p>The following sections describe the workflow for submitting code to include in the water-use project to complete these tasks. It is assumed we have already forked the repository and checked it out locally. Assuming the project is already fully in-swing, you should be able to jump in after loading the <code>vizlab</code> package and creating your make files:</p>
<pre><code>library(vizlab)
createProfile()
createMakefiles() </code></pre>
</div>
<div id="task-1-pull-in-new-data" class="section level2">
<h2>Task 1: Pull in new data</h2>
<p>Our first task was to add new (fictional) data to the project. Perhaps the data is sensitive, therefore, we have created a space on ScienceBase <a href="https://www.sciencebase.gov" class="uri">https://www.sciencebase.gov</a>, and managed the permissions so only our team has read/write abilities. Because of the sensitive data, authentication with sciencebase is required, this is done by running:</p>
<pre><code>storeSBcreds()</code></pre>
<p>and type username and password. We established a service account for ScienceBase that should be used if at all possible, otherwise AD login is supported.</p>
<p>Before adding/changing any code to the project, we create a branch on our fork dedicated to this task.</p>
<p>The whole <code>vizlab</code> process is coordinated by the <code>viz.yaml</code> file. Since we are “fetching” new data, we add a new job in the fetch section:</p>
<pre><code>fetch:
  -
  *************bunch of stuff already there************
  -
    id: oldThermoData
    location: cache/thermoelectric_1955.csv
    fetcher: sciencebase
    remoteItemId: &quot;XXX123&quot;
    remoteFilename: &quot;thermoelectric_1955.csv&quot;
    refetch: FALSE
    mimetype: text/csv
    scripts: 
</code></pre>
<p>What is this? We’ve added a new fetch job, and given it some information:</p>
<ul>
<li>A unique id “oldThermoData”. Downstream parts of this project that depend on this data will need to refer to this step by the unique id.</li>
<li>A “location”, which is the relative path where the file that is produced from this job will be stored.</li>
<li>The “fetcher” field indicates to <code>vizlab</code> to go to ScienceBase, look for the ScienceBase’s ID “XXX123”, and pull down the file “thermoelectric_1955.csv” from that ID.</li>
<li>The “refetch” set to FALSE means that this step should not be consistently repeated (for example, when you are re-building the project for some other step well downstream of this point). If we would expect the data might change, we would want this set to TRUE.</li>
<li>An optional field “mimetype”, this allows future jobs that depends on this data to know how to open the data.<br />
</li>
<li>A “scripts”&quot; field is where we could put custom scripts. In this particular case, we don’t actually need any custom scripts because the ‘fetcher’ refers to a function already defined in <code>vizlab</code> (so we don’t need to define our own). However, currently <code>vizlab</code> will give a warning if this field is missing.</li>
</ul>
<p>That’s it for Task #1! We commit our changes to the viz.yaml, push them up to our fork, and submit a pull request. Another member of our team should review the pull request and merge if it looks good.</p>
</div>
<div id="task-2-incorporating-the-data" class="section level2">
<h2>Task 2: Incorporating the data</h2>
<p>Since we are starting a new task, it’s a good idea to start a new branch. This task is to merge this new data from our csv into the data that is already available. This will be a task where we edit an existing process. Here is the original “process”&quot; field in the viz.yaml:</p>
<pre><code>process:
  -
    id: calc-nationalData
    location: cache/nationalClean.rds
    processor: nationalClean
    scripts: scripts/process/nationalClean.R
    reader: rds
    depends:
      stateData: calc-histWaterData
</code></pre>
<p>We need to add a new dependency, and fiddle with the script itself. So, let’s add the new data to depends like this:</p>
<pre><code>process:
  -
    id: calc-nationalData
    location: cache/nationalClean.rds
    processor: nationalClean
    scripts: scripts/process/nationalClean.R
    reader: rds
    depends:
      stateData: calc-histWaterData
      oldData: oldThermoData</code></pre>
<p>So in this processing job, we’ve added a new entry in the “depends” field, which is the unique id for the job we completed in Task 1. What that means is that this processing job will have 2 dependent data sources. The <code>stateData</code> is the 1960-2015 state data, and the <code>oldThermoData</code> is our recent addition.</p>
<p>Now, let’s look at the original script in: scripts/process/nationalClean.R:</p>
<pre><code>process.nationalClean &lt;- function(viz &lt;- getContentInfo(viz.id = &quot;calc-nationalData&quot;)){
  library(tidyr)
  library(dplyr)
  
  viz.data &lt;- readDepends(viz)
  stateData &lt;- viz.data[['stateData']]
  
  national &lt;- stateData %&gt;%
    group_by(year, category) %&gt;%
    summarise(value = sum(value)) %&gt;%
    data.frame()
  
  national$value[national$year &lt; 1960 &amp; 
                   national$category %in% c(&quot;Industrial&quot;,&quot;Thermoelectric&quot;)] &lt;- NA
  
  national$year[which(is.na(national$year))] = 2015
  
  saveRDS(national, file=viz[[&quot;location&quot;]])
}</code></pre>
<p>We need to add the data and merge:</p>
<pre><code>process.nationalClean &lt;- function(viz &lt;- getContentInfo(viz.id = &quot;calc-nationalData&quot;)){
  library(tidyr)
  library(dplyr)
  
  viz.data &lt;- readDepends(viz)
  stateData &lt;- viz.data[['stateData']]
  oldData &lt;- viz.data[['oldData']]

  national &lt;- stateData %&gt;%
    left_join(oldData, by=year) %&gt;%
    group_by(year, category) %&gt;%
    summarise(value = sum(value)) %&gt;%
    data.frame()
  
  national$value[national$year &lt; 1960 &amp; 
                   national$category %in% c(&quot;Industrial&quot;,&quot;Thermoelectric&quot;)] &lt;- NA
  
  national$year[which(is.na(national$year))] = 2015
  

  saveRDS(national, file=viz[[&quot;location&quot;]])
}</code></pre>
<p>Notice how the <code>depends</code> and <code>location</code> work.</p>
<p>Seems about right, but we should probably test. What’s the easiest way to jump into your custom process task? Unfortunately, using <code>make</code> and RStudio (a common practice on our team), we can’t simply add breakpoints to the script.</p>
<p>You can load the <code>viz</code> object like this:</p>
<pre><code>viz &lt;- getContentInfo(viz.id = &quot;calc-nationalData&quot;)</code></pre>
<p>and step through our function line-by-line.</p>
<p>For fewer keystrokes, you can run <code>process.nationalClean</code> in <code>debug</code> mode, since <code>viz</code> is defined by default using <code>getContentInfo</code>.</p>
<pre><code>viz
$id
[1] &quot;calc-nationalData&quot;

$location
[1] &quot;cache/nationalClean.rds&quot;

$processor
[1] &quot;nationalClean&quot;

$scripts
[1] &quot;scripts/process/nationalClean.R&quot;

$reader
[1] &quot;rds&quot;

$depends
$depends$stateData
[1] &quot;calc-histWaterData&quot;
$depends$oldData
[1] &quot;oldThermoData&quot;

$block
[1] &quot;process&quot;

$export
[1] FALSE</code></pre>
<p>Once we’ve verified that our job works as expected, and doesn’t break anything in the <code>make</code> build, we can submit our next pull request on this branch, and patiently wait for our project leader to assign us a new task.</p>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
